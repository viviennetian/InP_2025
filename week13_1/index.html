<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Match: Light Theme</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f2f2f7; /* iOS æµ…ç°èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        h1 {
            font-weight: 600;
            margin-bottom: 20px;
            color: #1c1c1e;
        }
        
        /* å¡ç‰‡å®¹å™¨ */
        .ui-panel {
            background: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); /* æŸ”å’Œé˜´å½± */
            text-align: center;
            width: 820px;
        }

        /* ä¸‹æ‹‰èœå• */
        .select-container {
            margin-bottom: 20px;
        }
        select {
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #d1d1d6;
            background-color: #f2f2f7;
            color: #333;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        /* æŒ‰é’®ç»„ */
        .controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        button {
            padding: 10px 24px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        /* æŒ‰é’®é¢œè‰²ç³»ç»Ÿ */
        .btn-target { background-color: #FF9500; color: white; } /* æ©™è‰² */
        .btn-target:hover { background-color: #e08900; }
        
        .btn-play { background-color: #007AFF; color: white; } /* è“è‰² */
        .btn-play:hover { background-color: #0062cc; }
        
        .btn-check { background-color: #34C759; color: white; } /* ç»¿è‰² */
        .btn-check:hover { background-color: #2da84e; }

        #feedback {
            margin-top: 20px;
            height: 20px;
            font-size: 14px;
            color: #8e8e93;
            font-weight: 500;
        }
        
        #canvas-container {
            border-radius: 12px;
            overflow: hidden;
            /* box-shadow: inset 0 0 20px rgba(0,0,0,0.02); */
        }
    </style>
</head>
<body>

    <h1>ğŸ”Š éŸ³é¢‘å¤åˆ»æŒ‘æˆ˜</h1>

    <div class="ui-panel">
        <div class="select-container">
            <label for="song-select" style="margin-right:10px; color:#666;">å½“å‰ä»»åŠ¡:</label>
            <select id="song-select" onchange="changeSong()">
                <option value="iphone">ğŸ“± iPhone (Opening)</option>
                <option value="windows">ğŸ’» Windows XP (Startup)</option>
                <option value="mario">ğŸ„ Super Mario (Intro)</option>
            </select>
        </div>

        <div id="canvas-container"></div>
        
        <div class="controls">
            <button class="btn-target" onclick="playTarget()">ğŸ‘‚ å¬ç›®æ ‡åŸå£°</button>
            <button class="btn-play" onclick="playUser()">â–¶ï¸ æ’­æ”¾æˆ‘çš„åºåˆ—</button>
            <button class="btn-check" onclick="checkMatch()">âœ… æäº¤è¯„åˆ†</button>
        </div>
        <div id="feedback">é€‰æ‹©ä»»åŠ¡å¹¶å¼€å§‹è°ƒæ•´æ»‘å—...</div>
    </div>

<script>
// --- å…¨å±€é…ç½® ---
const NUM_STEPS = 12;
const STEP_DURATION = 180; 
let sliders = [];
let oscillator, envelope;   
let isPlaying = false;
let currentPlayStep = -1;
let playTimer;

// --- æ›²åº“æ•°æ® ---
const songs = {
    iphone: [
        { pitch: 0.60, sustain: false, mute: false },
        { pitch: 0.50, sustain: false, mute: false },
        { pitch: 0.60, sustain: false, mute: false },
        { pitch: 0.50, sustain: false, mute: true }, 
        { pitch: 0.90, sustain: false, mute: false },
        { pitch: 0.60, sustain: false, mute: false },
        { pitch: 0.40, sustain: false, mute: false },
        { pitch: 0.90, sustain: false, mute: false },
        { pitch: 0.00, sustain: false, mute: true }, 
        { pitch: 0.60, sustain: false, mute: false },
        { pitch: 0.90, sustain: false, mute: false },
        { pitch: 0.50, sustain: true,  mute: false } 
    ],
    windows: [
        { pitch: 0.20, sustain: false, mute: false },
        { pitch: 0.20, sustain: false, mute: true  },
        { pitch: 0.45, sustain: false, mute: false },
        { pitch: 0.45, sustain: false, mute: true  },
        { pitch: 0.70, sustain: false, mute: false },
        { pitch: 0.75, sustain: false, mute: false },
        { pitch: 0.90, sustain: true,  mute: false },
        { pitch: 0.90, sustain: true,  mute: false },
        { pitch: 0.65, sustain: true,  mute: false },
        { pitch: 0.65, sustain: false, mute: false },
        { pitch: 0.00, sustain: false, mute: true  },
        { pitch: 0.00, sustain: false, mute: true  } 
    ],
    mario: [
        { pitch: 0.65, sustain: false, mute: false },
        { pitch: 0.65, sustain: false, mute: false },
        { pitch: 0.65, sustain: false, mute: false },
        { pitch: 0.00, sustain: false, mute: true  },
        { pitch: 0.50, sustain: false, mute: false },
        { pitch: 0.65, sustain: false, mute: false },
        { pitch: 0.00, sustain: false, mute: true  },
        { pitch: 0.90, sustain: false, mute: false },
        { pitch: 0.90, sustain: false, mute: true  },
        { pitch: 0.90, sustain: false, mute: true  },
        { pitch: 0.20, sustain: false, mute: false },
        { pitch: 0.20, sustain: false, mute: true  } 
    ]
};

let currentTarget = songs.iphone;

// --- p5.js åˆå§‹åŒ– ---
function setup() {
    let cnv = createCanvas(800, 320);
    cnv.parent('canvas-container');

    // éŸ³é¢‘åˆå§‹åŒ– (Triangleæ³¢å½¢æ›´é€‚åˆå¤å¤/ç”µå­éŸ³)
    oscillator = new p5.Oscillator('triangle'); 
    oscillator.start();
    oscillator.amp(0); 
    envelope = new p5.Env();
    envelope.setADSR(0.01, 0.1, 0.4, 0.1); 
    envelope.setRange(0.5, 0); 

    // åˆå§‹åŒ–æ»‘å—å¸ƒå±€
    const marginX = 60;
    const spacing = (width - marginX * 2) / NUM_STEPS;
    
    for (let i = 0; i < NUM_STEPS; i++) {
        let x = marginX + i * spacing;
        let y = 50;
        let w = 16;  // ç¨å¾®ç»†ä¸€ç‚¹çš„è½¨é“
        let h = 200;
        sliders.push(new StepSlider(x, y, w, h, i));
    }
    
    changeSong(); 
}

function draw() {
    background(255); // çº¯ç™½èƒŒæ™¯
    
    // ç»˜åˆ¶æµ…ç°è‰²çš„å‚è€ƒçº¿
    stroke(245);
    strokeWeight(1);
    for(let i=0; i<=5; i++) {
        let y = sliders[0].y + (sliders[0].h / 5) * i;
        line(20, y, width-20, y);
    }

    // ç»˜åˆ¶æ»‘å—è½¨é“ (åº•éƒ¨çš„ç°è‰²é•¿æ¡)
    noStroke();
    for (let s of sliders) {
        fill(240); // æµ…ç°è½¨é“
        rect(s.x, s.y, s.w, s.h, 10);
    }

    // ç»˜åˆ¶è¿çº¿ (æ”¾åœ¨æ»‘å—çƒä½“åé¢)
    noFill();
    stroke(120, 220, 255); // æµ…é’è“è‰²è¿çº¿
    strokeWeight(3);
    beginShape();
    for (let s of sliders) {
        if (!s.mute) vertex(s.x + s.w/2, s.handleY);
    }
    endShape();

    // ç»˜åˆ¶æ»‘å—ä¸»ä½“
    for (let s of sliders) s.display();
}

// --- é€»è¾‘æ§åˆ¶ ---
function changeSong() {
    let select = document.getElementById('song-select');
    currentTarget = songs[select.value];
    let feedback = document.getElementById('feedback');
    feedback.innerText = "ä»»åŠ¡å·²æ›´æ–°ï¼Œè¯·ç‚¹å‡»â€œå¬ç›®æ ‡åŸå£°â€";
    feedback.style.color = "#8e8e93";
}

// --- æ»‘å—ç±» ---
class StepSlider {
    constructor(x, y, w, h, index) {
        this.x = x; this.y = y; this.w = w; this.h = h; this.index = index;
        this.pitch = 0.5;
        this.sustain = false;
        this.mute = false;
        this.handleY = y + h * 0.5;
        this.isDragging = false;
    }

    display() {
        this.handleY = this.y + (1 - this.pitch) * this.h;
        
        // 1. éŸ³é«˜æ§åˆ¶çƒ (Handle)
        if (this.mute) {
            fill(220); // é™éŸ³æ—¶å˜ç°
        } else {
            fill(100, 210, 255); // é’è“è‰² (Cyan)
        }
        
        // æ’­æ”¾æ—¶çš„é«˜äº®æ•ˆæœ
        if (this.index === currentPlayStep && !this.mute) {
            stroke(100, 210, 255, 100); 
            strokeWeight(8); // å¤–å‘å…‰
        } else {
            noStroke();
        }
        
        ellipse(this.x + this.w/2, this.handleY, 24, 24); // éŸ³é«˜çƒ

        // 2. åº•éƒ¨æŒ‰é’®åŒº
        let btnY = this.y + this.h + 25;
        
        // Sustain æŒ‰é’® (æµ…é»„è‰²)
        this.drawBtn(this.sustain, "Sus", btnY, [255, 210, 80]); 
        
        // Mute æŒ‰é’® (æµ…ç»¿è‰²/æµ…çº¢è‰²)
        // è®¾è®¡è°ƒæ•´ï¼šMuteå¼€å¯æ—¶æ˜¾ç¤ºçº¢è‰²ï¼Œå…³é—­æ—¶æ˜¾ç¤ºæµ…ç»¿(ä»£è¡¨Active)æˆ–è€…ç°è‰²
        // è¿™é‡Œé€»è¾‘ï¼šå¼€å¯Mute = çº¢è‰²è­¦å‘Šè‰²
        this.drawBtn(this.mute, "Mute", btnY + 25, [255, 100, 100]); 
    }

    drawBtn(isActive, label, y, activeColor) {
        if (isActive) fill(activeColor); 
        else fill(235); // æœªæ¿€æ´»æ—¶çš„æµ…ç°è‰²
        
        noStroke();
        ellipse(this.x + this.w/2, y, 14, 14);
        
        // æ ‡ç­¾æ–‡å­—
        fill(180); 
        textSize(9); 
        textAlign(CENTER);
        text(label, this.x + this.w/2, y + 3); // ç¨å¾®å±…ä¸­ä¸€ç‚¹ï¼Œä¸æ”¾ä¸‹é¢äº†
    }

    checkHit(mx, my) {
        // éŸ³é«˜çƒåˆ¤å®š
        if (dist(mx, my, this.x + this.w/2, this.handleY) < 20) {
            this.isDragging = true; this.updatePitch(my); return true;
        }
        // è½¨é“ç‚¹å‡»åˆ¤å®š (è¾…åŠ©ä½“éªŒ)
        if (mx > this.x && mx < this.x + this.w && my > this.y && my < this.y + this.h) {
             this.isDragging = true; this.updatePitch(my); return true;
        }
        
        let btnY = this.y + this.h + 25;
        // Sustain åˆ¤å®š
        if (dist(mx, my, this.x + this.w/2, btnY) < 12) {
            this.sustain = !this.sustain; return true;
        }
        // Mute åˆ¤å®š
        if (dist(mx, my, this.x + this.w/2, btnY + 25) < 12) {
            this.mute = !this.mute; return true;
        }
        return false;
    }

    updatePitch(my) {
        let val = map(my, this.y + this.h, this.y, 0, 1);
        this.pitch = constrain(val, 0, 1);
    }
}

// --- é¼ æ ‡äº¤äº’ ---
function mousePressed() {
    userStartAudio();
    for (let s of sliders) if (s.checkHit(mouseX, mouseY)) break; 
}
function mouseDragged() {
    for (let s of sliders) if (s.isDragging) s.updatePitch(mouseY);
}
function mouseReleased() {
    for (let s of sliders) s.isDragging = false;
}

// --- éŸ³é¢‘å¼•æ“ ---
function getFreq(val) {
    let note = map(val, 0, 1, 48, 72); // C3 - C5
    return midiToFreq(note);
}

function playNote(data) {
    if (data.mute) return;
    let freq = getFreq(data.pitch);
    oscillator.freq(freq, 0.05);
    let relTime = data.sustain ? 0.3 : 0.05;
    envelope.setADSR(0.01, 0.05, 0.4, relTime);
    envelope.play(oscillator, 0, 0.1);
}

function runSequence(seqData) {
    if (isPlaying) return;
    isPlaying = true;
    currentPlayStep = 0;
    let count = 0;
    
    function next() {
        if (count >= NUM_STEPS) {
            isPlaying = false; currentPlayStep = -1; return;
        }
        currentPlayStep = count;
        playNote(seqData[count]);
        count++;
        playTimer = setTimeout(next, STEP_DURATION);
    }
    next();
}

// --- æŒ‰é’®äº‹ä»¶ ---
function playUser() {
    document.getElementById('feedback').innerText = "â–¶ï¸ æ’­æ”¾å½“å‰æ»‘å—åºåˆ—...";
    runSequence(sliders);
}
function playTarget() {
    document.getElementById('feedback').innerText = "ğŸ¶ æ­£åœ¨æ’­æ”¾ç›®æ ‡æ ·æœ¬...";
    runSequence(currentTarget);
}

function checkMatch() {
    if (isPlaying) return;
    let totalDiff = 0;
    
    for (let i = 0; i < NUM_STEPS; i++) {
        let u = sliders[i];
        let t = currentTarget[i];
        
        if (t.mute) {
            if (!u.mute) totalDiff += 2.0; 
        } else {
            if (u.mute) {
                totalDiff += 2.0; 
            } else {
                let diff = Math.abs(u.pitch - t.pitch);
                totalDiff += diff * 5; 
                if (u.sustain !== t.sustain) totalDiff += 0.5;
            }
        }
    }

    let el = document.getElementById('feedback');
    if (totalDiff < 1.5) {
        el.innerText = "ğŸ‰ å®Œç¾åŒ¹é…ï¼å¬åŠ›æ»¡åˆ†ï¼";
        el.style.color = "#34C759";
    } else if (totalDiff < 4.0) {
        el.innerText = "ğŸ¤ éå¸¸æ¥è¿‘äº†ï¼Œæ³¨æ„å¾®è°ƒéŸ³é«˜...";
        el.style.color = "#FF9500";
    } else {
        el.innerText = "âŒ å·®å¼‚è¾ƒå¤§ï¼Œè¯·å¯¹æ¯”å›¾è°±å†è¯• (è¯¯å·®: " + totalDiff.toFixed(1) + ")";
        el.style.color = "#FF3B30";
    }
}
</script>
</body>
</html>